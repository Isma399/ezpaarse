#!/bin/bash
#
# Script used to generate a debian package of ezPAARSE
#

set -e

CUR_DIR=`pwd`
MY_PATH=$(cd ${0%/*} && echo $PWD/${0##*/})
BIN_PATH=`dirname "$MY_PATH"`
EZPAARSE_PATH=$BIN_PATH/..
TMP_PATH=$EZPAARSE_PATH/tmp

. $BIN_PATH/env

# get the wanted version number
VERSION=$v
VERSION_PREFIX=""
[ -z "$VERSION" ] && VERSION="`$BIN_PATH/readconfig -k version`"
# get the latest commit id as the latest version number
if [ "$VERSION" == "latest" ]; then
  VERSION="`git log --pretty=format:'%h' -n 1`"
  VERSION_PREFIX="`date +"%Y%m%d"`"
fi

rm -rf $TMP_PATH/ezpaarse/
mkdir -p $TMP_PATH/ezpaarse/usr/share/

# clone the git with the correct name
git clone file://$EZPAARSE_PATH $TMP_PATH/ezpaarse/usr/share/ezpaarse
cd $TMP_PATH/ezpaarse/usr/share/ezpaarse
git checkout $VERSION
cp -f $EZPAARSE_PATH/Makefile $TMP_PATH/ezpaarse/usr/share/ezpaarse
touch $TMP_PATH/ezpaarse/usr/share/ezpaarse/clean-for-release-flag
make version v=$VERSION_PREFIX$VERSION
cp -r $TMP_PATH/ezpaarse/usr/share/ezpaarse/misc/deb/* $TMP_PATH/ezpaarse/
make clean-for-release
cd $TMP_PATH/ezpaarse/

# LSBization of ezpaarse source code

# /etc/init.d/ezpaarse
mkdir -p $TMP_PATH/ezpaarse/etc/init.d/
mkdir -p $TMP_PATH/ezpaarse/var/log/ezpaarse
mkdir -p $TMP_PATH/ezpaarse/var/run/

# /etc/ezpaarse/
mkdir -p $TMP_PATH/ezpaarse/etc/ezpaarse
mv $TMP_PATH/ezpaarse/usr/share/ezpaarse/config.json  $TMP_PATH/ezpaarse/etc/ezpaarse/
mv $TMP_PATH/ezpaarse/usr/share/ezpaarse/package.json $TMP_PATH/ezpaarse/etc/ezpaarse/
ln -s /etc/ezpaarse/config.json  $TMP_PATH/ezpaarse/usr/share/ezpaarse/config.json
ln -s /etc/ezpaarse/package.json $TMP_PATH/ezpaarse/usr/share/ezpaarse/package.json
sed -i 's#"development"#"production"#g' $TMP_PATH/ezpaarse/etc/ezpaarse/config.json

# create .deb
NAME="ezpaarse"
cd $TMP_PATH/
fakeroot dpkg-deb --build $NAME

# adjust package name
PACKAGE=`dpkg-deb -f $NAME.deb package`
ARCHI=`dpkg-deb -f $NAME.deb architecture`
NAMENEW="${PACKAGE}-${VERSION_PREFIX}${VERSION}_${ARCHI}"
mkdir -p $CUR_DIR/ezpaarse-$VERSION_PREFIX$VERSION/
mv $NAME.deb $CUR_DIR/ezpaarse-$VERSION_PREFIX$VERSION/${NAMENEW}.deb

echo "ezpaarse debian package built: $CUR_DIR/ezpaarse-$VERSION_PREFIX$VERSION/${NAMENEW}.deb"
cd $CUR_DIR

#rm -rf $TMP_PATH/ezpaarse/

exit 0