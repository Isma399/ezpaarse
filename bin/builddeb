#!/bin/bash
#
# Script used to generate a debian package of ezPAARSE
#

set -e

CUR_DIR=`pwd`
MY_PATH=$(cd ${0%/*} && echo $PWD/${0##*/})
BIN_PATH=`dirname "$MY_PATH"`
EZPAARSE_PATH=$BIN_PATH/..

. $BIN_PATH/env

# must be root to generate the package
if [ "`id -u`" != 0 ]; then
  echo "Error: run this script as a root user"
  exit 1
fi

[ -z "$VERSION" ] && VERSION="`$BIN_PATH/readconfig -k version`"
if [ ! -f $EZPAARSE_PATH/ezpaarse-$VERSION/ezpaarse-${VERSION}.tar.gz ]; then
  echo "Error: $EZPAARSE_PATH/ezpaarse-$VERSION/ezpaarse-${VERSION}.tar.gz  does not exist. Please run 'make zip' before."
  exit 1
fi

rm -rf /tmp/ezpaarse/
mkdir -p /tmp/ezpaarse/usr/share/

# todo: remplacer par l'utilisation d'un tar.gz versionnÃ© (make release)
cd /tmp/ezpaarse/usr/share/
tar xzf $EZPAARSE_PATH/ezpaarse-$VERSION/ezpaarse-${VERSION}.tar.gz 
mv /tmp/ezpaarse/usr/share/ezpaarse-$VERSION/ /tmp/ezpaarse/usr/share/ezpaarse/
cd /tmp/ezpaarse/

# prepare folders structure
cp -r $EZPAARSE_PATH/misc/deb/* /tmp/ezpaarse/

# cleanup
#rm -rf /tmp/ezpaarse/usr/share/ezpaarse/logs/
#rm -rf /tmp/ezpaarse/usr/share/ezpaarse/.git/
#rm -rf /tmp/ezpaarse/usr/share/ezpaarse/test/
#rm -rf /tmp/ezpaarse/usr/share/ezpaarse/build/
#rm -rf /tmp/ezpaarse/usr/share/ezpaarse/misc/
#rm -rf /tmp/ezpaarse/usr/share/ezpaarse/platforms/*/test/
#rm -rf /tmp/ezpaarse/usr/share/ezpaarse/*.deb
#rm -rf /tmp/ezpaarse/usr/share/ezpaarse/*.rpm
#find /tmp/ezpaarse/usr/share/ezpaarse/node_modules/ -name "tests"     -type d -exec rm -rf {} \; 2>/dev/null || true
#find /tmp/ezpaarse/usr/share/ezpaarse/node_modules/ -name "test"      -type d -exec rm -rf {} \; 2>/dev/null || true
#find /tmp/ezpaarse/usr/share/ezpaarse/node_modules/ -name "dist"      -type d -exec rm -rf {} \; 2>/dev/null || true
#find /tmp/ezpaarse/usr/share/ezpaarse/node_modules/ -name "build"     -type d -exec rm -rf {} \; 2>/dev/null || true
#find /tmp/ezpaarse/usr/share/ezpaarse/node_modules/ -name "example"   -type d -exec rm -rf {} \; 2>/dev/null || true
#find /tmp/ezpaarse/usr/share/ezpaarse/node_modules/ -name "examples"  -type d -exec rm -rf {} \; 2>/dev/null || true
#find /tmp/ezpaarse/usr/share/ezpaarse/node_modules/ -name "benchmark" -type d -exec rm -rf {} \; 2>/dev/null || true

# LSBization of ezpaarse source code

# /etc/init.d/ezpaarse
mkdir -p /tmp/ezpaarse/etc/init.d/
mkdir -p /tmp/ezpaarse/var/log/ezpaarse
mkdir -p /tmp/ezpaarse/var/run/

# /etc/ezpaarse/
mkdir -p /tmp/ezpaarse/etc/ezpaarse
mv /tmp/ezpaarse/usr/share/ezpaarse/config.json  /tmp/ezpaarse/etc/ezpaarse/
mv /tmp/ezpaarse/usr/share/ezpaarse/package.json /tmp/ezpaarse/etc/ezpaarse/
ln -s /etc/ezpaarse/config.json  /tmp/ezpaarse/usr/share/ezpaarse/config.json
ln -s /etc/ezpaarse/package.json /tmp/ezpaarse/usr/share/ezpaarse/package.json
sed -i 's#"development"#"production"#g' /tmp/ezpaarse/etc/ezpaarse/config.json

# create .deb
NAME="ezpaarse"
cd /tmp/
chown root:root -R ./ezpaarse/
dpkg-deb --build $NAME

# adjust package name
PACKAGE=`dpkg-deb -f $NAME.deb package`
VERSION=`dpkg-deb -f $NAME.deb version`
ARCHI=`dpkg-deb -f $NAME.deb architecture`
NAMENEW="${PACKAGE}-${VERSION}_${ARCHI}"
mv $NAME.deb $CUR_DIR/ezpaarse-$VERSION/${NAMENEW}.deb

echo "ezpaarse debian package built: $CUR_DIR/ezpaarse-$VERSION/${NAMENEW}.deb"
cd $CUR_DIR

rm -rf /tmp/ezpaarse/

exit 0