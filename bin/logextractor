#!/usr/bin/env node
//
// Command used to extracte just a field from log lines
//

/*jslint node: true, maxlen: 100, maxerr: 50, indent: 2 */
'use strict';

var byline = require('byline');
var fs = require('fs');
var tabRegex = require('../logformat.js');

// get the command line argument 
// platform
var optimist = require('optimist')
    .usage('Extract specific field from a log stream\nUsage: $0 --field=[string]')
    .demand('field').alias('field', 'f')
    .describe('field', 'field to extract from the url (ex: url or login or host)');
var argv = optimist.argv;

// show usage if --help option is used
if (argv.help) {
  optimist.showHelp();
  process.exit(0);
}

var field = argv.field;
var linenb = 1;
var stream = byline.createStream(process.stdin);
stream.on('data', function (line) {
  var match;
  var caught = tabRegex.some(function (regex) {
    match = regex.exp.exec(line);
    if (match) {
      var fieldIndex = regex.properties.indexOf(field);
      if (fieldIndex !== -1) {
        process.stdout.write(match[fieldIndex+1] + '\n');
      } else {
        process.stderr.write('Error: field ' + field + ' not found in line ' + linenb + '\n');
      }
    }
  });
  linenb++;
});
