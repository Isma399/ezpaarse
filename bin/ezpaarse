#!/bin/bash
#
# ezPAARSE start stop restart status script
#

EZPAARSE_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"
PATH=$EZPAARSE_PATH/build/nvm/bin/latest/:$EZPAARSE_PATH/node_modules/.bin:/usr/local/bin:/usr/bin:/bin
EZPAARSE_PIDFILE="$EZPAARSE_PATH/ezpaarse.pid"
PORT=$($EZPAARSE_PATH/bin/readconfig --key EZPAARSE_NODEJS_PORT)
APPNAME=$($EZPAARSE_PATH/bin/readconfig --key name)
EZPAARSE_VERSION=$($EZPAARSE_PATH/bin/readconfig --key EZPAARSE_VERSION)
EZPAARSE_LOGDIR="$EZPAARSE_PATH/logs"

# check make build has been called
if [ ! -d $EZPAARSE_PATH/build/ ]; then
  echo "$APPNAME error: please run make build before anything" >&2
  exit 1
fi

# if ezpaarse pid file doesn't exist, create a fake one
if [ ! -f $EZPAARSE_PIDFILE ]; then
  echo "XXXX" > $EZPAARSE_PIDFILE
fi

ezpaarse_start() {
  if [ "$EZPAARSE_VERSION" == "development" ]; then
    # NODE_ENV used to control the expressjs development or production flag
    NODE_ENV=${NODE_ENV:="$EZPAARSE_VERSION"}
    # DEBUG used to activate verbose and colored logs on stdout
    DEBUG=${DEBUG:="*"}
    # run app.js forground to help developer
    NODE_ENV="$NODE_ENV" DEBUG="$DEBUG" node $EZPAARSE_PATH/app.js --pidFile $EZPAARSE_PIDFILE
  else
    forever start -a -l $EZPAARSE_LOGDIR/forever.log \
                     -o $EZPAARSE_LOGDIR/out.log \
                     -e $EZPAARSE_LOGDIR/err.log \
                     --pidFile $EZPAARSE_PIDFILE \
                     --sourceDir $EZPAARSE_PATH app.js 1>/dev/null
  fi
}

ezpaarse_stop() {
  forever stop --sourceDir $EZPAARSE_PATH app.js 1>/dev/null
}

ezpaarse_restart() {
  forever restart --sourceDir $EZPAARSE_PATH app.js 1>/dev/null
}

case $1 in

  start)
    if [ -d /proc/`cat $EZPAARSE_PIDFILE` ]; then
      echo "$APPNAME is already running, listening on http://localhost:$PORT/"
      exit 0
    else
      $EZPAARSE_PATH/bin/checkconfig -p &> /dev/null
      if [[ $? -eq 0 ]]; then
        ezpaarse_start
        if [ -d /proc/`cat $EZPAARSE_PIDFILE` ]; then
          echo "$APPNAME started, listening on http://localhost:$PORT/"
          exit 0
        else
          echo "$APPNAME cannot be started."
          exit 1
        fi
      else
        echo "The port $PORT is already used, $APPNAME cannot be started"
        exit 1
      fi
    fi
  ;;

  stop)
    if [ ! -d /proc/`cat $EZPAARSE_PIDFILE` ]; then
      echo "$APPNAME is already stopped."
      exit 0
    else
      ezpaarse_stop
      if [ -d /proc/`cat $EZPAARSE_PIDFILE` ]; then
        echo "$APPNAME cannot be stopped."
        exit 1
      else
        echo "$APPNAME is stopped."
        exit 0
      fi
    fi
  ;;

  restart | reload | force-reload)
    if [ ! -d /proc/`cat $EZPAARSE_PIDFILE` ]; then
      ezpaarse_start
    else
      ezpaarse_restart
    fi
    if [ -d /proc/`cat $EZPAARSE_PIDFILE` ]; then
      echo "$APPNAME has been restarted, listening on http://localhost:$PORT/"
      exit 0
    else
      echo "$APPNAME cannot be restarted."
      exit 1
    fi    
  ;;

  status)
    if [ -d /proc/`cat $EZPAARSE_PIDFILE` ]; then
      echo "$APPNAME is running, listening on http://localhost:$PORT/"
      exit 0
    else
      echo "$APPNAME is not running."
      exit 1
    fi
  ;;

  *)
    echo "Usage: $0 {start|stop|restart|status}"
    exit 1
  ;;

esac